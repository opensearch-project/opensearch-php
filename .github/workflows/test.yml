name: PHP

on:
  push:
    paths:
      - "**.php"
  pull_request:

jobs:
  code-style:
    name: Code Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: yaml, zip, curl
        env:
          COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          composer install --prefer-dist

      - name: PHP CS Fixer
        run: |
          composer run-script php-cs

  static-analyse:
    name: PHPStan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: yaml, zip, curl
        env:
          COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          composer install --prefer-dist

      - name: PHP Static Analysis Tool
        run: |
          composer run-script phpstan

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    services:
      search-server:
        image: opensearchproject/opensearch:3
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
          plugins.security.disabled: true
          OPENSEARCH_INITIAL_ADMIN_PASSWORD: myStrongPassword123!

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: yaml, zip, curl, pcov
        env:
          COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          composer install --prefer-dist

      - name: Wait for cluster to be healthy
        uses: ./.github/actions/health-check

      - name: PHPUnit
        run: |
          composer run-script phpunit
        env:
          OPENSEARCH_URL: 'http://localhost:9200'

      - uses: codecov/codecov-action@v3
        with:
          file: ./clover.xml

  unit-test:
    name: "Unit Test"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        php-version:
          - '8.1'
          - '8.2'
          - '8.3'
          - '8.4'
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Use PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: yaml, zip, curl
      env:
        COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   
    - name: Install dependencies
      run: |
        composer install --prefer-dist

    - name: Unit tests
      run: |
        composer run unit

  integration-test-elasticsearch:
    name: Integration Test (Elasticsearch)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        search-server-image:
          - docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.0
    services:
      search-server:
        image: ${{ matrix.search-server-image }}
        ports:
          - 9200:9200
        env:
          discovery.type: single-node

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Use PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.3
        extensions: yaml, zip, curl
      env:
        COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   
    - name: Install dependencies
      run: |
        composer install --prefer-dist

    - name: Integration tests
      run: |
        composer run integration
      env:
        OPENSEARCH_URL: 'http://localhost:9200'

  integration-test-opensearch:
    name: Integration Test (OpenSearch)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        search-server-image:
          - opensearchproject/opensearch:1
          - opensearchproject/opensearch:2
          - opensearchproject/opensearch:3
    services:
      search-server:
        image: ${{ matrix.search-server-image }}
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
          plugins.security.disabled: true
          OPENSEARCH_INITIAL_ADMIN_PASSWORD: myStrongPassword123!

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Use PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.3
        extensions: yaml, zip, curl
      env:
        COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   
    - name: Install dependencies
      run: |
        composer install --prefer-dist

    - name: Wait for cluster to be healthy
      uses: ./.github/actions/health-check

    - name: Integration tests
      run: |
        composer run integration
      env:
        OPENSEARCH_URL: 'http://localhost:9200'
